# docker-compose.yml
services:
  db_host:
    hostname: db.oken-cars.oken.lan
    container_name: db_host
    image: postgres:13
    restart: always
    environment:
      POSTGRES_USER: useroken
      POSTGRES_PASSWORD: 12345
      POSTGRES_DB: okendb
    ports:
      - "5432:5432"
    networks:
      - mynet
  spring:
     hostname: spring-oken-cars.oken.lan
     build:
       context: ./spring
       dockerfile: Dockerfile
     container_name: spring-app
     environment:
        SPRING_DATASOURCE_URL: jdbc:postgresql://db_host:5432/okendb
     restart: always
     depends_on:
       - db_host
     ports:
       - "8081:8081"
       - "30303:30303"
     networks:
       - mynet
  angular:
    hostname: angular-oken-cars.oken.lan
    build:
      context: ./angular
      dockerfile: Dockerfile
    container_name: angular-app
    restart: always
    depends_on:
      - spring
    ports:
      - "4200:4200"
    networks:
      - mynet
  apache:
    hostname: oken-cars.oken.lan
    build:
      context: ./apache
      dockerfile: Dockerfile
    container_name: apache-app
    restart: always
    depends_on:
      - spring
      - angular
    ports:
      - "80:80"
    networks:
      - mynet
  prometheus:
    image: prom/prometheus:latest
    command:
      - --storage.tsdb.retention.time=7d
      - --config.file=/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - mynet
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    volumes:
      - ./grafana-provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana-provisioning/datasources:/etc/grafana/provisioning/datasources
    networks:
      - mynet
  node_exporter_1:
    image: prom/node-exporter:latest
    ports:
      - "9100:9100"
    networks:
      - mynet
  node_exporter_2:
    image: prom/node-exporter:latest
    ports:
      - "9101:9100"
    networks:
      - mynet

networks:
  mynet:
    driver: bridge
